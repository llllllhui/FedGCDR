# FedGCDR 模型保存与加载使用指南

## 概述

本文档介绍如何在FedGCDR项目中保存和加载预训练知识，支持断点续训和增量学习。

## 参数说明

### 保存相关参数

- `--save_checkpoint`: 训练完成后是否保存完整检查点（默认：True）
- `--save_pretrained`: 是否保存预训练嵌入向量（默认：True）
- `--checkpoint_path`: 指定要加载的检查点文件路径（默认：None）
- `--pretrained_path`: 指定要加载的预训练嵌入文件路径（默认：None）

### 自动参数

- `--skip_gat`: 是否跳过GAT训练（加载检查点时自动设置为True）
- `--only_ft`: 是否仅进行微调（加载检查点时自动设置为True）

## 使用示例

### 1. 首次训练并保存检查点

```bash
python main.py --dataset amazon --num_domain 4 --target_domain 1 --save_checkpoint True
```

### 2. 加载检查点继续微调

```bash
python main.py --checkpoint_path checkpoints/fedgcdr_checkpoint_2026-02-02_02_56_23.pt --round_ft 5
```

加载检查点时会自动：
- ✅ 跳过知识训练阶段（所有域的GAT训练）
- ✅ 跳过ASYNC阶段（目标域知识激活）
- ✅ 直接进入微调阶段（Fine-tuning）
- ✅ 恢复所有模型参数、嵌入向量和知识向量

### 3. 仅保存预训练嵌入（轻量级）

```bash
python main.py --save_pretrained True --save_checkpoint False
```

### 4. 加载预训练嵌入

```bash
python main.py --pretrained_path embedding/pretrained/pretrained_embeddings_2026-02-02_02_56_23.pt
```

## 保存内容对比

### 完整检查点（推荐）

包含以下所有内容：
- ✅ 所有服务器的模型参数（U, V, user_embedding_with_attention, domain_attention）
- ✅ 所有服务器的GAT网络状态（item_gat）
- ✅ 所有MLP模型参数
- ✅ 所有客户端的知识向量
- ✅ 训练元数据（数据集、目标域、训练阶段等）

**文件大小**：较大（通常几十MB到几百MB）

### 预训练嵌入（轻量级）

仅包含：
- ✅ 用户嵌入向量（U）
- ✅ 物品嵌入向量（V）
- ✅ 用户注意力嵌入（user_embedding_with_attention）

**文件大小**：较小（通常几MB到几十MB）

## 检查点机制详解

### 训练阶段标识

检查点会记录当前所处的训练阶段：
- `knowledge`: 知识训练阶段（GAT训练）
- `async`: ASYNC阶段（目标域知识激活）
- `fine_tuning`: 微调阶段

### 加载检查点后的行为

当使用 `--checkpoint_path` 加载检查点时：

1. **自动跳过重复训练**
   - 跳过知识训练阶段（所有域的GAT训练）
   - 跳过ASYNC阶段（目标域知识激活）
   - 直接进入微调阶段

2. **状态恢复**
   - 所有服务器参数恢复到检查点时的状态
   - 所有客户端知识向量恢复
   - MLP模型参数恢复
   - 域注意力权重恢复

3. **引用关系重建**
   - 自动为所有Client重建MLP引用
   - 确保知识转换功能正常工作

## 重要注意事项

### 1. 知识向量一致性

检查点中的知识向量和嵌入向量来自同一训练阶段，确保了语义一致性。**不要**同时使用：
- 检查点中的嵌入向量
- 旧JSON文件中的知识向量

这会导致语义不一致，影响模型性能。

### 2. 设备一致性

加载检查点时会自动将所有参数移动到指定设备（通过 `--device` 参数）。

### 3. 参数一致性

确保加载检查点时的参数与保存时一致，特别是：
- `--num_domain`: 域的数量
- `--target_domain`: 目标域
- `--embedding_size`: 嵌入维度
- `--dataset`: 数据集名称

如果参数不匹配，系统会发出警告。

## 优势

1. **节省时间**：避免重复训练，跳过耗时的GAT训练阶段
2. **快速实验**：基于已有预训练模型进行快速微调和调参
3. **结果复现**：保存检查点可确保实验结果可复现
4. **增量学习**：支持从检查点继续训练
5. **灵活存储**：提供完整检查点和轻量级嵌入两种保存方式
6. **状态完整**：自动处理所有必要的引用关系和状态恢复

## 故障排查

### 问题1：加载检查点后效果不佳

**可能原因**：知识向量和嵌入向量来自不同训练阶段

**解决方案**：确保只使用检查点文件，不要同时加载旧的知识JSON文件

### 问题2：MLP引用丢失

**症状**：加载检查点后知识转换功能失效

**解决方案**：系统已自动修复此问题，加载检查点后会自动重建MLP引用

### 问题3：参数不匹配警告

**症状**：加载检查点时出现参数不匹配警告

**解决方案**：确保训练参数与保存检查点时的参数一致，特别是 `--num_domain` 和 `--target_domain`
